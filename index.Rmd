---
title: "Introduction to multiplex single-cell imaging"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true
---



```{r, echo = FALSE, message = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  message = FALSE
)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```




## Slide Deck

<iframe class="speakerdeck-iframe" frameborder="0" src="https://speakerdeck.com/player/19588e79e83146a8bc844ed2f335c79e" title="MI_intro" allowfullscreen="true" style="border: 0px; background: padding-box padding-box rgba(0, 0, 0, 0.1); margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 314;" data-ratio="1.78343949044586"></iframe>


## Multichannel TIFF Data

Here I briefly discuss loading and visualizing raw TIFF data. Typically I focus on data in tabular form post segmentation (not the raw images), but it's helpful to see what they look like.

### Lung cancer data

The following image is a single ROI from a tissue slice from a patient with non small cell lung carcinoma.Cell and tissue segmentation and cell phenotyping were performed using [inForm](https://www.akoyabio.com/phenoimager/software/inform-tissue-finder/) software. For each image, there are multiple Tiff files output by inForm:


* `lung_component_data.tif`: the multichannel file we are most interested in
* `lung_binary_seg_maps.tif`: 3 channel file with binary segmentation maps
* `lung.tif`: A composite image in RGB format. 


```{r}

# load relevant libraries
library(tidyverse)
library(tiff)
library(EBImage)


# define your specific file path
my_path = "./Data/"

# define file for different .tif files
img = paste0(my_path, "lung_component_data.tif")
segmentation = paste0(my_path, "lung_binary_seg_maps.tif")
composite_tif = paste0(my_path, "lung.tif")
```


### Image stack file


The `component.tif` file contains the multichannel tiff, which is a stack of individual images (one for each marker). Below I define a function to read the image stack file and extract metadata.

```{r}
# this function is from phenoptr package on GitHub
# extracts metadata specific to Vectra3/VectraPolaris images
read_image_stacks <- function(path) {
  stopifnot(file.exists(path), endsWith(path, 'component_data.tif'))

  tif = tiff::readTIFF(path, all=TRUE, info=TRUE)

  # Get the image descriptions and figure out which ones are components
  infos = purrr::map_chr(tif, ~attr(., 'description'))
  images = grepl('FullResolution', infos)

  # Get the image_stack names
  names = stringr::str_match(infos[images], '<Name>(.*)</Name>')[, 2]

  purrr::set_names(tif[images], names)
}

image_stack = read_image_stacks(img)
```

The `image_stack` object is now a list, where each list element is a different marker

```{r}
map(image_stack, dim)
```


I can use the `display()` function from the `EBImage` package to plot an individual channel. Below the DAPI (nucleus) channel is plotted.

```{r}
dapi_channel = t(image_stack$"DAPI (DAPI)")
EBImage::display(dapi_channel, method = "raster")


# plot the image in a specified color
dapi = rgbImage(blue=.1*dapi_channel, red = .02 * dapi_channel)
display(dapi, method = "raster")
```

### Segmentation files

This data was collected on a Vectra 3 instrument and segmented using [inForm](https://www.akoyabio.com/phenoimager/software/inform-tissue-finder/) tissue analysis     software from Akoya Biosciences. This is proprietary image analysis software that can perform cell and tissue segmentation and cell phenotyping. The segmentation below were performed by that software.

```{r}
# source phenoptr code for loading file and metadata, based on tiff::readTIFF.
source("https://raw.githubusercontent.com/akoyabio/phenoptr/main/R/read_maps.R")

segmentations = read_maps(segmentation)
names(segmentations)
```

Nucleus segmentation

```{r}
nucleus = segmentations[['Membrane']]
plot(as.raster(nucleus, max = max(nucleus)))
```


Tissue segmentation

```{r}
tissue = segmentations[['Tissue']]

plot(as.raster(tissue, max = max(tissue)))
```

### Composite file

```{r}
# source phenoptr code for loading file and metadata, based on tiff::readTIFF.
source("https://raw.githubusercontent.com/akoyabio/phenoptr/main/R/read_composites.R")

composite = read_composites(composite_tif)
```

```{r}
composite = as.raster(composite[[1]])
plot(composite)
```


```{r}
knitr::opts_chunk$set(
  eval = FALSE)
```

## VectraPolarisData


The [VectraPolarisData](https://bioconductor.org/packages/release/data/experiment/html/VectraPolarisData.html) [ExperimentHub](http://bioconductor.org/packages/release/bioc/html/ExperimentHub.html) package provides two large multiplex immunofluorescence datasets collected using Akoya Biosciences Vectra 3 and Vectra Polaris platforms. Image preprocessing (cell segmentation and phenotyping) was performed using [inForm](https://www.akoyabio.com/phenoimager/software/inform-tissue-finder/) software. Data are provided as objects of class [SpatialExperiment](https://bioconductor.org/packages/release/bioc/html/SpatialExperiment.html).

```{r, message = FALSE}
# load libraries
library(tidyverse)
```

### Install and load data

The data is publicly available on Bioconductor as the package `VectraPolarisData`. You can install the package from Bioconductor here:

```{r, eval = FALSE, echo = TRUE, message = FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
     install.packages("BiocManager")
}

BiocManager::install("VectraPolarisData")

```



## Ovarian cancer data 

Load the high grade serous ovarian cancer data. This dataset has been segmented and phenotyped, and has one image per patient.

```{r, message = FALSE, eval = FALSE}
library(VectraPolarisData)

# load spatial experiment object
oc <- HumanOvarianCancerVP()
```

Inspect the `SpatialExperiment` object.


Many of the variables are summary statistics of marker intensity values. More information on the different variables in this and the lung cancer dataset can be found in the [package vignette](https://bioconductor.org/packages/release/data/experiment/vignettes/VectraPolarisData/inst/doc/VectraPolarisData.html).


The resulting dataframe, `ovarian_df`, contains information on marker intensities, cell X and Y position, cell phenotypes, and patient-level characteristics.

### Exploratory analysis


```{r, eval = FALSE}
dim(ovarian_df)

head(ovarian_df)

glimpse(ovarian_df)
```


Below we plot the cells for a single subject. In this dataset there is one image for each subject, and the image comes from a tumor microarray (TMA).

```{r}
id = sample(ovarian_df$sample_id, 1)

ovarian_df %>%
  filter(sample_id == id) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(color = tissue_category), size = 0.1)


```

Now we plot the images (below) for multiple subjects. In this dataset, multiple TMA cores (each TMA core is frome a different subject) were placed on the same slide, and then that slide was imaged. X and Y locations in this data correspond to position on the slide for a given patient sample. 

```{r}
ovarian_df %>%
  filter(sample_id < 10) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(color = tissue_category), size = 0.1)
```


## Lung data

Load the non small cell lung carcinoma data and inspect the `SpatialExperiment` object. This dataset has 3-4 images per patient, representing different ROIs from a tissue slice. In this dataset, each patient was imaged on a separate slide.


### Exploratory analysis

Below shows images from a single subject. Each image represents a different ROI from the same tissue slice from a single subject. There are 3-6 ROIs for each subject. 

```{r}
id = sample(lung_df$patient_id, 1)

lung_df %>%
  filter(patient_id == id) %>%
  ggplot(aes(x, y)) +
  geom_point(aes(color = tissue_category), size = 0.1) +
  facet_wrap(~image_id)

```





## Additional Reading

Below are original citations for the two example datasets I will be working with in this tutorial.

* [Paper for ovarian cancer data](https://aacrjournals.org/mcr/article/19/12/1973/675069/The-Spatial-Context-of-Tumor-Infiltrating-Immune)
* [Paper for non-small cell lung carcinoma data](https://pubmed.ncbi.nlm.nih.gov/34048945/)
* [Vignette for VectraPolarisData](https://bioconductor.org/packages/release/data/experiment/vignettes/VectraPolarisData/inst/doc/VectraPolarisData.html)
* [textbook chapter, Wrobel and Vandekar](http://juliawrobel.com/Downloads/mIF_chapter.pdf)
* [Challenges and Opportunities in the Statistical Analysis of Multiplex Immunofluorescence Data](https://www.mdpi.com/2072-6694/13/12/3031)
* [Catching up with multiplexed tissue imaging](https://www.nature.com/articles/s41592-022-01428-z) 
* [The emerging landscape of spatial profiling technologies](https://www.nature.com/articles/s41576-022-00515-3)